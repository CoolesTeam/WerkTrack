<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werkzeugverwaltung App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { margin-bottom: 20px; }
    nav button { margin-right: 10px; }
    .hidden { display: none; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    table, th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f4f4f4; }
    .error { color: red; }
    .success { color: green; }
    textarea, input[type="text"], input[type="password"], input[type="file"], select { width: 100%; padding: 6px; margin-bottom: 6px; }
    img.tool-img { max-width: 60px; height: auto; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Auth Views -->
    <div id="auth-view">
      <h2>Login</h2>
      <form id="login-form">
        <label for="login-username">Benutzername:</label>
        <input type="text" id="login-username" required>
        <label for="login-password">Passwort:</label>
        <input type="password" id="login-password" required>
        <button type="submit">Login</button>
      </form>
      <div id="login-error" class="error"></div>
      <p>Noch keinen Account? <button id="show-register">Registrieren</button></p>
      <div id="register-view" class="hidden">
        <h2>Registrieren</h2>
        <form id="register-form">
          <label for="reg-username">Benutzername:</label>
          <input type="text" id="reg-username" required>
          <label for="reg-password">Passwort:</label>
          <input type="password" id="reg-password" required>
          <button type="submit">Registrieren</button>
        </form>
        <div id="register-error" class="error"></div>
      </div>
    </div>

    <!-- Main App View -->
    <div id="main-view" class="hidden">
      <header>
        <h1>Werkzeugverwaltung</h1>
        <nav>
          <button id="nav-list">Meine Ausleihen</button>
          <button id="nav-borrow">Ausleihen</button>
          <button id="nav-tools" class="hidden">Werkzeuge</button>
          <button id="nav-users" class="hidden">Mitarbeiter</button>
          <button id="logout">Logout</button>
        </nav>
        <hr>
      </header>
      <main id="content"></main>
    </div>
  </div>

  <script>
    const STORAGE = {
      users: 'wm_users',
      tools: 'wm_tools',
      borrowings: 'wm_borrowings',
      current: 'wm_current'
    };

    // Initialize storage with default admin and sample tools
    function initStorage() {
      const adminUser = { username: 'admin', password: 'admin', role: 'admin' };
      let users = JSON.parse(localStorage.getItem(STORAGE.users));
      if (!users) {
        users = [adminUser];
      } else {
        // Ensure admin always exists
        if (!users.find(u => u.username === 'admin')) {
          users.unshift(adminUser);
        }
      }
      localStorage.setItem(STORAGE.users, JSON.stringify(users));

      if (!localStorage.getItem(STORAGE.tools)) {
        const sample = [
          { id:1, name:'Hammer', description:'Robuster Hammer', image:'' },
          { id:2, name:'Schraubenzieher', description:'Kreuzschlitz', image:'' },
          { id:3, name:'Zange', description:'Seitenschneider', image:'' }
        ];
        localStorage.setItem(STORAGE.tools, JSON.stringify(sample));
      }
      if (!localStorage.getItem(STORAGE.borrowings)) {
        localStorage.setItem(STORAGE.borrowings, JSON.stringify([]));
      }
    }
    initStorage();

    let currentUser = null;

    // Helpers
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }
    function showMessage(msg, type='success') {
      const div = document.createElement('div'); div.textContent = msg; div.className = type;
      content.prepend(div); setTimeout(() => div.remove(), 3000);
    }

    // Auth
    const authView = document.getElementById('auth-view');
    const loginForm = document.getElementById('login-form');
    const regBtn = document.getElementById('show-register');
    const regView = document.getElementById('register-view');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    regBtn.onclick = () => {
      hide(loginForm);
      hide(loginError);
      show(regView);
    };

    loginForm.onsubmit = e => {
      e.preventDefault();
      loginError.textContent = '';
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value;
      const users = JSON.parse(localStorage.getItem(STORAGE.users));
      const user = users.find(x => x.username === u && x.password === p);
      if (user) {
        currentUser = user;
        localStorage.setItem(STORAGE.current, JSON.stringify(user));
        startApp();
      } else {
        loginError.textContent = 'Ung端ltige Anmeldedaten';
      }
    };

    registerForm.onsubmit = e => {
      e.preventDefault();
      registerError.textContent = '';
      const u = document.getElementById('reg-username').value.trim();
      const p = document.getElementById('reg-password').value;
      let users = JSON.parse(localStorage.getItem(STORAGE.users));
      if (users.find(x => x.username === u)) {
        registerError.textContent = 'Benutzer existiert';
        return;
      }
      const newUser = { username: u, password: p, role: 'employee' };
      users.push(newUser);
      localStorage.setItem(STORAGE.users, JSON.stringify(users));
      alert('Registrierung erfolgreich. Bitte einloggen.');
      show(loginForm);
      hide(regView);
    };

    // Navigation handlers
    const btnList = document.getElementById('nav-list');
    const btnBorrow = document.getElementById('nav-borrow');
    const btnTools = document.getElementById('nav-tools');
    const btnUsers = document.getElementById('nav-users');
    const btnLogout = document.getElementById('logout');
    const content = document.getElementById('content');

    btnLogout.onclick = () => {
      localStorage.removeItem(STORAGE.current);
      location.reload();
    };
    btnList.onclick = listBorrowings;
    btnBorrow.onclick = borrowForm;
    btnTools.onclick = manageTools;
    btnUsers.onclick = manageUsers;

    window.onload = () => {
      const saved = localStorage.getItem(STORAGE.current);
      if (saved) {
        currentUser = JSON.parse(saved);
        startApp();
      }
    };

    // Start App
    function startApp() {
      hide(authView);
      show(document.getElementById('main-view'));
      if (currentUser.role === 'admin') {
        show(btnTools);
        show(btnUsers);
      }
      listBorrowings();
    }

    // Borrowings
    function listBorrowings() {
      const all = JSON.parse(localStorage.getItem(STORAGE.borrowings));
      const tools = JSON.parse(localStorage.getItem(STORAGE.tools));
      const list = currentUser.role === 'admin' ? all : all.filter(b => b.user === currentUser.username);
      let html = '<h2>Ausleihen</h2>';
      if (!list.length) html += '<p>Keine Ausleihen.</p>';
      else {
        html += '<table><tr><th>#</th><th>Bild</th><th>Tool</th><th>Mitarbeiter</th><th>Ausleihdatum</th><th>R端ckgabe</th><th>Defekt</th><th>Aktion</th></tr>';
        list.forEach(b => {
          const t = tools.find(x => x.id === b.toolId);
          html += `<tr><td>${b.id}</td>` +
                  `<td>${t.image ? `<img src="${t.image}" class="tool-img">` : '-'}</td>` +
                  `<td>${t.name} (${t.id})</td>` +
                  `<td>${b.user}</td>` +
                  `<td>${new Date(b.borrowDate).toLocaleString()}</td>` +
                  `<td>${b.returnDate ? new Date(b.returnDate).toLocaleString() : '-'}</td>` +
                  `<td>${b.defect || '-'}</td>` +
                  `<td>${!b.returnDate ? `<button onclick="returnTool(${b.id})">Zur端ckgeben</button>` : '-'}</td></tr>`;
        });
        html += '</table>';
      }
      content.innerHTML = html;
    }
    function borrowForm() {
      const tools = JSON.parse(localStorage.getItem(STORAGE.tools));
      let html = '<h2>Werkzeug ausleihen</h2><form id="borrow-form"><select id="tool-select">';
      tools.forEach(t => html += `<option value="${t.id}">${t.name} (${t.id})</option>`);
      html += '</select><textarea id="defect" rows="2" placeholder="Defekt (optional)"></textarea><button>Ausleihen</button></form>';
      content.innerHTML = html;
      document.getElementById('borrow-form').onsubmit = e => {
        e.preventDefault();
        const toolId = parseInt(document.getElementById('tool-select').value);
        const defect = document.getElementById('defect').value.trim();
        const arr = JSON.parse(localStorage.getItem(STORAGE.borrowings));
        const nid = arr.length ? Math.max(...arr.map(x => x.id)) + 1 : 1;
        arr.push({ id: nid, toolId, user: currentUser.username, borrowDate: new Date().toISOString(), returnDate: null, defect });
        localStorage.setItem(STORAGE.borrowings, JSON.stringify(arr));
        listBorrowings();
      };
    }
    function returnTool(id) {
      const arr = JSON.parse(localStorage.getItem(STORAGE.borrowings));
      const obj = arr.find(x => x.id === id);
      if (obj) {
        obj.returnDate = new Date().toISOString();
        localStorage.setItem(STORAGE.borrowings, JSON.stringify(arr));
      }
      listBorrowings();
    }

    // Tools management
    function manageTools() {
      const tools = JSON.parse(localStorage.getItem(STORAGE.tools));
      let html = '<h2>Werkzeuge verwalten</h2><form id="add-tool"><input type="text" id="t-name" placeholder="Name" required>' +
                 '<input type="text" id="t-desc" placeholder="Beschreibung"><input type="file" id="t-img" accept="image/*"><button>Hinzuf端gen</button></form>' +
                 '<table><tr><th>ID</th><th>Bild</th><th>Name</th><th>Beschreibung</th><th>Aktion</th></tr>';
      tools.forEach(t => html += `<tr><td>${t.id}</td><td>${t.image ? `<img src="${t.image}" class="tool-img">` : '-'}`
